<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <base href="/examples/DT2/">
    <title>Unity WebGL Player - DeadTrigger 2 WebGL Demo</title>
    <style type="text/css">
    <!--
    body {
      font-family: Helvetica, Verdana, Arial, sans-serif;
      background-color: white;
      color: black;
      text-align: center;
    }
    a:link, a:visited {
      color: #000;
    }
    a:active, a:hover {
      color: #666;
    }
    p.header {
      font-size: small;
    }
    p.header span {
      font-weight: bold;
    }
    p.footer {
      font-size: x-small;
    }
    -->
    </style>
    <style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      textarea.emscripten { font-family: monospace; width: 80%; }
      div.emscripten { text-align: center; }
      canvas.emscripten { border: 0px none; }
    </style>
    <link rel="stylesheet" href="html_resources/style.css">
    <script src="UnityProgress.js"></script>
    <script src="UnityConfig.js"></script>
  </head>
  <body class="demo-deadtrigger2">
    <p class="header"><span>Unity WebGL Player</span></p>
    <div class="demo-wrap clear">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" height="720px" width="1280px"></canvas>
      <div class="logo"></div>
      <div class="fullscreen"><img src="html_resources/fullscreen.png" width="38" height="38" alt="Fullscreen" title="Fullscreen" onclick="launchFullscreen(canvas);" /></div>
      <div class="title">MadFinger Games - DeadTrigger 2</div>
    </div>
    <p class="footer">&laquo; created with <a href="http://unity3d.com/unity/" title="Go to unity3d.com">Unity</a> &raquo;</p>
    <script type='text/javascript'>
      function launchFullscreen(element) {
      if(element.requestFullscreen) {
        element.requestFullscreen();
      } else if(element.mozRequestFullScreen) {
        element.mozRequestFullScreen();
      } else if(element.webkitRequestFullscreen) {
        element.webkitRequestFullscreen();
      } else if(element.msRequestFullscreen) {
        element.msRequestFullscreen();
      }
      }
      // connect to canvas
      var Module = {
        preRun: [],
        postRun: [],
        print: (function() {
          return function(text) {
            console.log (text);
          };
        })(),
        printErr: function(text) {
          console.log (text);
        },
        canvas: document.getElementById('canvas'),
        progress: null,
        setStatus: function(text) {
          if (this.progress == null)
          {
            if (typeof UnityProgress != 'function')
              return;
            this.progress = new UnityProgress (canvas, {});
          }
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          this.progress.SetMessage (text);
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          if (m)
            this.progress.SetProgress (parseInt(m[2])/parseInt(m[4]));
          if (text === "")
            this.progress.Clear()
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
    </script>
    <script src="fileloader.js"></script>
    <script async type="text/javascript" src="output.js"></script>
    <script src="../../js/host.bundle.js"></script>
    <script>
      var pad = MobileGamepad.create();

      var allowedEvents = {
        'KeyboardEvent': [
          'input',
          'keydown',
          'keypress',
          'keyup'
        ],
        'MouseEvent': [
          'click',
          'contextmenu',
          'dblclick',
          'mousedown',
          'mouseenter',
          'mouseleave',
          'mousemove',
          'mouseout',
          'mouseover',
          'mouseup'
        ]
      };

      function triggerEvent(type, props, element) {
        var eventProps = {
          bubbles: true,
          toElement: document.body
        };
        Object.keys(props || {}).forEach(function (prop) {
          eventProps[prop] = props[prop];
        });

        // TODO: Get DOM L3/L4 events working in Chrome (works in Firefox).
        var event = document.createEvent('HTMLEvents');
        event.initEvent(type, true, true);
        event.eventName = type;
        Object.keys(eventProps).forEach(function (prop) {
          event[prop] = eventProps[prop];
        });

        (element || document.body || window).dispatchEvent(event);
      }

      window.addEventListener('keydown', function (e) {
        switch (e.keyCode) {
          case 37:
            // left
            console.log('left: keydown');
            break;
          case 38:
            // up
            console.log('up: keydown');
            break;
          case 39:
            // right
            console.log('right: keydown');
            break;
          case 40:
            // down
            console.log('down: keydown');
            break;
        }
      });

      window.addEventListener('keyup', function (e) {
        switch (e.keyCode) {
          case 37:
            // left
            console.log('left: keyup');
            break;
          case 38:
            // up
            console.log('up: keyup');
            break;
          case 39:
            // right
            console.log('right: keyup');
            break;
          case 40:
            // down
            console.log('down: keyup');
            break;
        }
      });

      window.addEventListener('keydown', function (e) {
        switch (e.keyCode) {
          case 73:
            // I: up
            // console.log('I: up - keypress / keydown');
            triggerEvent('keypress', buttonEvents.up);
            triggerEvent('keydown', buttonEvents.up);
            break;
          case 74:
            // J: left
            // console.log('J: left - keypress / keydown');
            triggerEvent('keypress', buttonEvents.left);
            triggerEvent('keydown', buttonEvents.left);
            break;
          case 75:
            // K: down
            // console.log('K: down - keypress / keydown');
            triggerEvent('keypress', buttonEvents.down);
            triggerEvent('keydown', buttonEvents.down);
            break;
          case 76:
            // L: right
            // console.log('L: right - keypress / keydown');
            triggerEvent('keypress', buttonEvents.right);
            triggerEvent('keydown', buttonEvents.right);
            break;
        }
      });

      window.addEventListener('keyup', function (e) {
        switch (e.keyCode) {
          case 73:
            // I: up
            // console.log('I: up – keyup');
            triggerEvent('keyup', buttonEvents.up);
            break;
          case 74:
            // J: left
            // console.log('J: left – keyup');
            triggerEvent('keyup', buttonEvents.left);
            break;
          case 75:
            // K: down
            // console.log('K: down – keyup');
            triggerEvent('keyup', buttonEvents.down);
            break;
          case 76:
            // L: right
            // console.log('L: right – keyup');
            triggerEvent('keyup', buttonEvents.right);
            break;
        }
      });

      function loop(func) {
        var loop;
        window.requestAnimationFrame(loop = function () {
          func();
          window.requestAnimationFrame(loop);
        });
      }

      function getGamepads() {
        var apis = [
          'getGamepads',
          'webkitGetGamepads',
          'webkitGamepads'
        ];
        for (var i = 0; i < apis.length; i++) {
          if (apis[i] in navigator) {
            return navigator[apis[i]]();
          }
        }
        return [];
      }

      if ('ongamepadconnected' in window) {
        window.addEventListener('gamepadconnected', startPolling);
        window.addEventListener('gamepaddisconnected', stopPolling);
      } else {
        startPolling();
      }

      var state = {};

      var gamepad;
      var thres = .1;

      var events = {
        key: {
          on: ['keydown', 'keypress'],
          off: ['keyup']
        },
        click: {
          on: ['mousedown'],
          off: ['mouseup', 'click']
        },
        hover: {
          on: ['mousedown'],
          off: ['mouseup', 'click']
        }
      };

      var gamepadControls = {
        start: {
          trigger: 'keypress',
          data: {key: 'Enter', keyCode: 13},
          when: function (gamepad) {
            // Ensure game has started.
            return gamepad.buttons[9];
          }
        },
        pause: {
          trigger: 'keypress',
          data: {key: 'p', keyCode: 80},
          when: function (gamepad) {
            // Ensure game hasn't started yet.
            return gamepad.buttons[9];
          }
        },
        left: {
          trigger: 'keypress',
          data: {key: 'ArrowLeft', keyCode: 37},
          when: function (gamepad) {
            // Left on left joystick.
            return [
              gamepad.axes[0] < -thres,
              gamepad.axes[0] >= -thres
            ];
          }
        },
        right: {
          trigger: 'keypress',
          data: {key: 'ArrowRight', keyCode: 39},
          when: function (gamepad) {
            // Right on left joystick.
            return [
              gamepad.axes[0] > thres,
              gamepad.axes[0] <= thres
            ];
          }
        }
        down: {
          trigger: 'keypress',
          data: {key: 'ArrowDown', keyCode: 40},
          when: function (gamepad) {
            // Down on left joystick.
            return [
              gamepad.axes[1] > thres,
              gamepad.axes[1] <= thres
            ];
          }
        },
        up: {
          trigger: 'keypress',
          data: {key: 'ArrowUp', keyCode: 38},
          when: function (gamepad) {
            // Up on left joystick.
            return [
              gamepad.axes[1] < -thres,
              gamepad.axes[1] >= -thres
            ];
          }
        },
        move: {
          trigger: 'keypress',
          data: function (gamepad) {
            var w = document.documentElement.clientWidth;
            var h = document.documentElement.clientHeight;
             return {
              x: gamepad.axes[2] * w,
              y: gamepad.axes[2] * h
            };
          },
          when: function () {
            return true;
          }
        },

        attack: {
          when: function (gamepad) {
            return gamepad.buttons[1];
          },
          then: 'click'
        },
;

{
  'buttons.0': 'click',
  'axes.0': 'left',
  'axes.1': 'right',
  'axes.2': 'down',
  'axes.3': 'up'
}

gamepad.whenGamepad(function (gamepad) {
  return [
    gamepad.axes[0] > thres,
    gamepad.axes[0] <= thres
  ];
}).then({'click': 'body'});


gamepad.trigger({'keypress': 'tab'}, function (gamepad) {
  return gamepad.buttons[3];
});




var keys = {
  1: 49,
  2: 50,
  3: 51
  ArrowDown: 40,
  ArrowLeft: 37,
  ArrowRight: 39,
  ArrowUp: 38,
  Enter: 13,
  Tab: 9,
  p: 80,
  q: 81
};

{
        attack: {
          when: function (gamepad) {
            // `A` button is pressed.
            return gamepad.buttons[1];
          },
          whenNot: function (gamepad) {
            // `A` button is released.
            return !gamepad.buttons[1];
          },
          then: 'click'
          data: {},
        },
        toggleCombat: {
          'keypress tab':

          trigger: 'keypress',
          data: {key: 'Tab', keyCode: 9}
          when: function (gamepad) {
            // `Y` button is pressed.
            return gamepad.buttons[3];
          },
          whenNot: function (gamepad) {
            // `Y` button is released.
            return !gamepad.buttons[3];
          }
        },
        toggleWeapons: {
          when: function (gamepad) {
            // `X` button is pressed.
            return gamepad.buttons[0];
          },
          whenNot: function (gamepad) {
            // `X` button is released.
            return !gamepad.buttons[0];
          },
          trigger: 'keypress',
          data: {key: 'q', keyCode: 81}
        },
        special1: {
          trigger: 'keypress',
          data: {key: '1', keyCode: 49}
        },
        special2: {
          trigger: 'keypress',
          data: {key: '2', keyCode: 50}
        },
        special3: {
          trigger: 'keypress',
          data: {key: '3', keyCode: 51}
        }
      };


      function handleButton(name, value, bindToEvent) {
        if (!state[name] && value) {
          state[name] = true;
          if (bindToEvent === 'click') {
            handleButton[]
            triggerEvent('mousedown', buttonsToFire.buttons[name]);
          } else {
            triggerEvent('keydown', buttonsToFire.buttons[name]);
            triggerEvent('keypress', buttonsToFire.buttons[name]);
          }
        } else if (state[name] && !value) {
          state[name] = false;
          if (bindToEvent === 'click') {
            triggerEvent('mouseup', buttonsToFire.buttons[name]);
            triggerEvent('click', buttonsToFire.buttons[name]);
          } else {
            triggerEvent('keyup', buttonsToFire.buttons[name]);
          }
        }
        return state[name];
      }

      function handleAxis(name, active, inactive, bindToEvent) {
        if (!state[name] && active) {
          state[name] = true;
          if (bindToEvent === 'click') {
            triggerEvent('mousedown', buttonsToFire.buttons[name]);
          } else {
            triggerEvent('keypress', buttonsToFire.buttons[name]);
            triggerEvent('keydown', buttonsToFire.buttons[name]);
          }
        } else if (state[name] && inactive) {
          state[name] = false;
          if (bindToEvent === 'click') {
            triggerEvent('mouseup', buttonsToFire.buttons[name]);
            triggerEvent('click', buttonsToFire.buttons[name]);
          } else {
            triggerEvent('keyup', buttonsToFire.buttons[name]);
          }
        }
        return state[name];
      }

      // game keyboard controls:
      //
      // W/A/S/D (or arrow keys) to walk [DONE]
      // click to attack
      // mouse to look
      // Q to switch weapons
      // Tab to switch to meleé combat
      // 1/2/3 for special powers

      function startPolling() {
        loop(function () {
          console.log('loop');
          if (!gamepad) {
            gamepad = getGamepads()[0];
          }
          if (!gamepad) {
            return;
          }

          // gamepad mapping:
          //
          // gamepad.buttons[0]: X
          // gamepad.buttons[1]: A
          // gamepad.buttons[2]: B
          // gamepad.buttons[3]: Y
          // gamepad.buttons[4]: LB
          // gamepad.buttons[5]: RB
          // gamepad.buttons[6]: L
          // gamepad.buttons[7]: R
          // gamepad.buttons[8]: Back
          // gamepad.buttons[9]: Start
          //
          // left joystick:
          // gamepad.axes[1]: -1 left, +1 right
          // gamepad.axes[2]: -1 up, +1 down
          //
          // right joystick:
          // gamepad.axes[3]: -1 left, +1 right
          // gamepad.axes[4]: -1 up, +1 down

          handleButton('start', gamepad.buttons[9], 'key');
          handleButton('a', gamepad.buttons[1], 'click');

          // left joystick (to walk)
          handleAxis('left', gamepad.axes[0] < -thres, gamepad.axes[0] >= -thres, 'key');
          handleAxis('right', gamepad.axes[0] > thres, gamepad.axes[0] <= thres, 'key');

          handleAxis('up', gamepad.axes[1] < -thres, gamepad.axes[1] >= -thres, 'key');
          handleAxis('down', gamepad.axes[1] > thres, gamepad.axes[1] <= thres, 'key');

          // right joystick (to look)
          handleAxis('left', gamepad.axes[2] < -thres, gamepad.axes[2] >= -thres, 'key');
          handleAxis('right', gamepad.axes[2] > thres, gamepad.axes[2] <= thres, 'key');

          handleAxis('up', gamepad.axes[3] < -thres, gamepad.axes[3] >= -thres, 'key');
          handleAxis('down', gamepad.axes[3] > thres, gamepad.axes[3] <= thres, 'key');

          // Update state.
          state.axes = gamepad.axes;
          state.buttons = gamepad.buttons;
        });
      }
    </script>
  </body>
</html>
